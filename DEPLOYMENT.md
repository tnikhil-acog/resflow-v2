# ResFlow - Simple Deployment Guide

## Your Setup

- âœ… Docker and Docker Compose on your servers
- âœ… Nginx handles external routing and SSL
- âœ… LDAP authentication (username/password verification)
- âœ… Just run `docker-compose up` and you're ready!

## Quick Deployment

### Step 1: Initial Setup (One-time)

```bash
# Navigate to project directory
cd resflow-v2

# Run automated setup
./setup-docker.sh
```

This script will:

- Generate secure passwords and API keys automatically
- Create the `.env` file
- Build Docker images
- Start all services

### Step 2: Start Services

```bash
docker-compose up -d
```

That's it! Your application is now running on port 3000.

## Configuration

### Minimal `.env` File

Only 4 variables are required:

```bash
POSTGRES_PASSWORD=<auto-generated>
JWT_SECRET=<auto-generated>
CRON_API_KEY=<auto-generated>
BASE_URL=http://localhost:3000
```

### Nginx Integration

Your nginx should proxy to:

- **Application:** `http://localhost:3000`
- **Container:** `resflow_app:3000` (if nginx is in same Docker network)

Example nginx config snippet:

```nginx
location / {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
}
```

## Automated Tasks (Cron Jobs)

Cron jobs run automatically inside the container:

| Task                    | Schedule       | What it does                                  |
| ----------------------- | -------------- | --------------------------------------------- |
| Daily log reminders     | 9:00 AM daily  | Creates tasks for employees to log work       |
| Weekly report reminders | 9:00 AM Monday | Creates tasks for employees to submit reports |

No additional cron setup needed on your host server!

## Daily Operations

### View Application Status

```bash
docker-compose ps
```

### View Logs

```bash
# Application logs
docker-compose logs -f app

# Cron job logs
docker exec resflow_app tail -f /var/log/cron-daily.log
docker exec resflow_app tail -f /var/log/cron-weekly.log
```

### Restart Application

```bash
docker-compose restart app
```

### Stop All Services

```bash
docker-compose down
```

### Update Application

```bash
git pull
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

## Verify Cron Jobs

```bash
# Check cron is running
docker exec resflow_app ps aux | grep cron

# List scheduled jobs
docker exec resflow_app crontab -l

# Manually trigger task generation (for testing)
docker exec resflow_app /app/scripts/cron-runner.sh daily
docker exec resflow_app /app/scripts/cron-runner.sh weekly
```

## Troubleshooting

### Application won't start

```bash
# Check logs
docker-compose logs app

# Check environment variables
docker exec resflow_app env | grep -E "DATABASE_URL|JWT_SECRET"
```

### Database connection failed

```bash
# Check database is running
docker-compose ps db

# Test database connection
docker exec resflow_db pg_isready -U resflowuser
```

### Cron jobs not running

```bash
# Verify cron daemon is running
docker exec resflow_app ps aux | grep cron

# Check if crontab is installed
docker exec resflow_app crontab -l

# Test manually
docker exec resflow_app /app/scripts/cron-runner.sh daily
```

## Backup and Restore

### Backup Database

```bash
docker exec resflow_db pg_dump -U resflowuser resflowdb > backup_$(date +%Y%m%d).sql
```

### Restore Database

```bash
cat backup_20260202.sql | docker exec -i resflow_db psql -U resflowuser -d resflowdb
```

## Need Help?

1. Check logs: `docker-compose logs -f app`
2. Verify cron: `docker exec resflow_app crontab -l`
3. Test manually: `docker exec resflow_app /app/scripts/cron-runner.sh daily`
4. Check database: `docker exec resflow_db pg_isready -U resflowuser`

## Summary

âœ… **Simple deployment:** Just `docker-compose up -d`  
âœ… **No manual cron setup:** Runs automatically in container  
âœ… **No LDAP config needed:** App handles authentication directly  
âœ… **Works with your nginx:** Just proxy port 3000  
âœ… **Auto-generated secrets:** Setup script creates secure keys

Your setup is optimized for simplicity! ðŸš€
